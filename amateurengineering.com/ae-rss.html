<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amateur Engineering - Hacker/Maker Blog Webring</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            margin: 40px 0;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .feed-item {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .feed-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .feed-item h2 {
            font-size: 1.4rem;
            margin-bottom: 12px;
            color: #2c3e50;
        }

        .feed-item h2 a {
            color: #2c3e50;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .feed-item h2 a:hover {
            color: #667eea;
        }

        .feed-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        .blog-name {
            font-weight: 600;
            color: #667eea;
        }

        .date {
            opacity: 0.8;
        }

        .feed-description {
            color: #555;
            line-height: 1.7;
        }

        .stats {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 1rem;
            opacity: 0.9;
        }

        .add-feed-info {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .add-feed-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .add-feed-info p {
            color: #666;
            margin-bottom: 10px;
        }

        .github-link {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 500;
            transition: background 0.3s ease;
            margin-top: 10px;
        }

        .github-link:hover {
            background: #5a6fd8;
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .feed-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Amateur Engineering</h1>
            <p>Hacker/Maker Blog Webring</p>
        </div>

        <div class="add-feed-info">
            <h3>Want to add your blog?</h3>
            <p>Submit a pull request to add your RSS feed to our community list!</p>
            <a href="#" class="github-link" id="githubLink">Add Your Feed on GitHub</a>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            Loading latest posts...
        </div>

        <div id="stats" class="stats" style="display: none;"></div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="feeds" class="feeds"></div>
    </div>

    <script>
        class RSSAggregator {
            constructor() {
                // You'll need to replace this with your actual GitHub raw file URL
                this.feedListUrl = 'https://raw.githubusercontent.com/obsoletenerd/AmateurEngineering/refs/heads/main/feeds.json';
                this.corsProxy = 'https://api.allorigins.win/raw?url=';
                this.maxPosts = 20;
            }

            async init() {
                try {
                    document.getElementById('githubLink').href = 'https://github.com/obsoletenerd/AmateurEngineering';
                    
                    this.showLoading(true);
                    const feeds = await this.loadFeedList();
                    const posts = await this.aggregateFeeds(feeds);
                    this.displayPosts(posts);
                    this.showStats(feeds.length, posts.length);
                } catch (error) {
                    this.showError('Failed to load feeds: ' + error.message);
                } finally {
                    this.showLoading(false);
                }
            }

            async loadFeedList() {
                try {
                    console.log('Fetching feed list from:', this.feedListUrl);
                    const response = await fetch(this.feedListUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const text = await response.text();
                    console.log('Raw JSON response:', text);
                    const data = JSON.parse(text);
                    console.log('Parsed data:', data);
                    return data.feeds || [];
                } catch (error) {
                    console.error('Error loading feed list:', error);
                    throw new Error(`Failed to load feed list: ${error.message}`);
                }
            }

            async aggregateFeeds(feeds) {
                const allPosts = [];
                const promises = feeds.map(feed => this.fetchFeed(feed));
                
                const results = await Promise.allSettled(promises);
                
                results.forEach((result, index) => {
                    if (result.status === 'fulfilled') {
                        allPosts.push(...result.value);
                    } else {
                        console.warn(`Failed to fetch feed ${feeds[index].name}:`, result.reason);
                    }
                });

                // Sort by date (newest first) and limit to maxPosts
                return allPosts
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, this.maxPosts);
            }

            async fetchFeed(feedInfo) {
                try {
                    console.log(`Fetching feed: ${feedInfo.name} from ${feedInfo.url}`);
                    const proxyUrl = this.corsProxy + encodeURIComponent(feedInfo.url);
                    console.log(`Using proxy URL: ${proxyUrl}`);
                    const response = await fetch(proxyUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    const xmlText = await response.text();
                    console.log(`Feed content length for ${feedInfo.name}: ${xmlText.length} chars`);
                    return this.parseFeed(xmlText, feedInfo);
                } catch (error) {
                    console.error(`Error fetching feed ${feedInfo.name}:`, error);
                    return [];
                }
            }

            parseFeed(xmlText, feedInfo) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(xmlText, 'text/xml');
                const posts = [];

                // Handle both RSS and Atom feeds
                const items = doc.querySelectorAll('item, entry');
                
                items.forEach(item => {
                    const title = this.getTextContent(item, 'title');
                    const link = this.getLink(item);
                    const description = this.getDescription(item);
                    const date = this.getDate(item);

                    if (title && link && date) {
                        posts.push({
                            title,
                            link,
                            description,
                            date,
                            blogName: feedInfo.name,
                            author: feedInfo.author || ''
                        });
                    }
                });

                return posts;
            }

            getTextContent(item, tagName) {
                const element = item.querySelector(tagName);
                return element ? element.textContent.trim() : '';
            }

            getLink(item) {
                // RSS
                let link = this.getTextContent(item, 'link');
                if (link) return link;

                // Atom
                const linkEl = item.querySelector('link[href]');
                return linkEl ? linkEl.getAttribute('href') : '';
            }

            getDescription(item) {
                let desc = this.getTextContent(item, 'description') ||
                          this.getTextContent(item, 'summary') ||
                          this.getTextContent(item, 'content');
                
                // Strip HTML tags and limit length
                desc = desc.replace(/<[^>]*>/g, '');
                return desc.length > 300 ? desc.substring(0, 300) + '...' : desc;
            }

            getDate(item) {
                const dateStr = this.getTextContent(item, 'pubDate') ||
                               this.getTextContent(item, 'published') ||
                               this.getTextContent(item, 'updated');
                return dateStr ? new Date(dateStr) : new Date();
            }

            displayPosts(posts) {
                const container = document.getElementById('feeds');
                container.innerHTML = '';

                if (posts.length === 0) {
                    container.innerHTML = '<div class="error">No posts found.</div>';
                    return;
                }

                posts.forEach(post => {
                    const postEl = document.createElement('div');
                    postEl.className = 'feed-item';
                    
                    postEl.innerHTML = `
                        <h2><a href="${post.link}" target="_blank" rel="noopener">${post.title}</a></h2>
                        <div class="feed-meta">
                            <span class="blog-name">${post.blogName}</span>
                            <span class="date">${this.formatDate(post.date)}</span>
                        </div>
                        <div class="feed-description">${post.description}</div>
                    `;
                    
                    container.appendChild(postEl);
                });
            }

            formatDate(date) {
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    return 'Today';
                } else if (diffDays === 1) {
                    return 'Yesterday';
                } else if (diffDays < 7) {
                    return `${diffDays} days ago`;
                } else {
                    return date.toLocaleDateString();
                }
            }

            showStats(feedCount, postCount) {
                const statsEl = document.getElementById('stats');
                statsEl.textContent = `Showing ${postCount} latest posts from ${feedCount} blogs`;
                statsEl.style.display = 'block';
            }

            showLoading(show) {
                document.getElementById('loading').style.display = show ? 'block' : 'none';
            }

            showError(message) {
                const errorEl = document.getElementById('error');
                errorEl.textContent = message;
                errorEl.style.display = 'block';
            }
        }

        // Initialize the aggregator when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const aggregator = new RSSAggregator();
            aggregator.init();
        });
    </script>
</body>
</html>